@extends('layouts.admin')

@section('title', 'Relatório - Equipamentos de Radiação Ionizante')

@section('content')
<div class="space-y-6" x-data="relatorioEquipamentosRadiacao()">
    {{-- Cabeçalho --}}
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="{{ route('admin.relatorios.index') }}" 
               class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Equipamentos de Radiação Ionizante</h1>
                <p class="text-gray-500 mt-1">Estabelecimentos com atividades que exigem equipamentos de radiação</p>
            </div>
        </div>
        <button @click="exportarExcel()" 
                class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Exportar Excel
        </button>
    </div>

    {{-- Cards de Resumo --}}
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-100 rounded-lg">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-gray-900">{{ $totais['total'] }}</p>
                    <p class="text-sm text-gray-500">Total de estabelecimentos</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-green-100 rounded-lg">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-green-600">{{ $totais['com_equipamentos'] }}</p>
                    <p class="text-sm text-gray-500">Com equipamentos</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-red-100 rounded-lg">
                    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-red-600">{{ $totais['sem_equipamentos'] }}</p>
                    <p class="text-sm text-gray-500">Sem equipamentos</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-orange-100 rounded-lg">
                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-orange-600">{{ $totais['total_equipamentos'] }}</p>
                    <p class="text-sm text-gray-500">Total de equipamentos</p>
                </div>
            </div>
        </div>
    </div>

    {{-- Toggle Visualização: Tabela / Mapa --}}
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Visualização</h3>
            <div class="inline-flex rounded-lg border border-gray-200 p-1 bg-gray-50">
                <button @click="visualizacao = 'tabela'" 
                        :class="visualizacao === 'tabela' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'"
                        class="px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    Tabela
                </button>
                <button @click="visualizacao = 'mapa'" 
                        :class="visualizacao === 'mapa' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'"
                        class="px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                    </svg>
                    Mapa
                </button>
            </div>
        </div>
    </div>

    {{-- Filtros --}}
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4" x-show="visualizacao === 'tabela'" x-collapse>
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex-1 min-w-[200px]">
                <input type="text" 
                       x-model="filtros.busca" 
                       @input.debounce.300ms="filtrar()"
                       placeholder="Buscar por nome ou CNPJ..."
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
            </div>
            
            <div>
                <select x-model="filtros.status" @change="filtrar()"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="">Todos os status</option>
                    <option value="com">Com equipamentos</option>
                    <option value="sem">Sem equipamentos</option>
                </select>
            </div>

            <div>
                <select x-model="filtros.atividade" @change="filtrar()"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="">Todas as atividades</option>
                    @foreach($atividades as $atividade)
                        <option value="{{ $atividade->id }}">{{ $atividade->descricao_atividade }}</option>
                    @endforeach
                </select>
            </div>

            <button @click="limparFiltros()" 
                    x-show="filtros.busca || filtros.status || filtros.atividade"
                    class="px-4 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                Limpar filtros
            </button>
        </div>
    </div>

    {{-- Visualização: Mapa do Tocantins --}}
    <div x-show="visualizacao === 'mapa'" x-collapse class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {{-- Mapa SVG do Tocantins --}}
            <div class="lg:col-span-2">
                <div class="relative bg-gradient-to-br from-blue-50 via-slate-50 to-green-50 rounded-xl overflow-hidden" style="min-height: 700px;">
                    {{-- Título do Mapa --}}
                    <div class="absolute top-4 left-4 z-20">
                        <h3 class="text-lg font-bold text-gray-800">Estado do Tocantins</h3>
                        <p class="text-xs text-gray-500">Clique em um município para ver os estabelecimentos</p>
                    </div>
                    
                    {{-- Controles de Zoom --}}
                    <div class="absolute top-4 right-4 z-20 flex flex-col gap-2">
                        <button @click="zoomIn()" 
                                class="w-10 h-10 bg-white rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 flex items-center justify-center text-gray-700 font-bold text-xl transition-colors"
                                title="Aumentar zoom">
                            +
                        </button>
                        <button @click="zoomOut()" 
                                class="w-10 h-10 bg-white rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 flex items-center justify-center text-gray-700 font-bold text-xl transition-colors"
                                title="Diminuir zoom">
                            −
                        </button>
                        <button @click="resetZoom()" 
                                class="w-10 h-10 bg-white rounded-lg shadow-lg border border-gray-200 hover:bg-gray-50 flex items-center justify-center text-gray-600 transition-colors"
                                title="Resetar zoom">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                            </svg>
                        </button>
                        <div class="bg-white rounded-lg shadow-lg border border-gray-200 px-2 py-1 text-center">
                            <span class="text-xs text-gray-500" x-text="Math.round(zoom * 100) + '%'"></span>
                        </div>
                    </div>
                    
                    {{-- Container do Mapa com Pan/Zoom --}}
                    <div class="w-full h-full overflow-hidden cursor-grab active:cursor-grabbing" 
                         style="min-height: 680px;"
                         @mousedown="startPan($event)"
                         @mousemove="doPan($event)"
                         @mouseup="endPan()"
                         @mouseleave="endPan()"
                         @wheel.prevent="handleWheel($event)">
                        
                        {{-- Container do SVG Real do Tocantins --}}
                        <div id="mapa-tocantins-container" 
                             class="w-full h-full flex items-center justify-center transition-transform duration-100"
                             :style="{ transform: `scale(${zoom}) translate(${panX}px, ${panY}px)` }">
                            {{-- O SVG será carregado via JavaScript --}}
                            <div class="text-center text-gray-400 py-20" id="mapa-loading">
                                <svg class="animate-spin h-8 w-8 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Carregando mapa do Tocantins...
                            </div>
                        </div>
                        
                        @php
                            // Dados de equipamentos por cidade - passados para JavaScript
                            $cidadesEquipamentosMap = [];
                            foreach($estabelecimentos as $est) {
                                $municipio = $est->cidade ?? 'Sem município';
                                $municipio = preg_replace('/\s*[-\/]\s*TO\s*$/i', '', $municipio);
                                $municipio = trim($municipio) ?: 'Sem município';
                                
                                if (!isset($cidadesEquipamentosMap[$municipio])) {
                                    $cidadesEquipamentosMap[$municipio] = ['total' => 0, 'estabelecimentos' => 0];
                                }
                                $cidadesEquipamentosMap[$municipio]['total'] += $est->equipamentos_count;
                                $cidadesEquipamentosMap[$municipio]['estabelecimentos']++;
                            }
                        @endphp
                    </div>
                            }
                            
                            // Função para obter cor baseada na quantidade de equipamentos
                            function obterCorEquipamentos($total) {
                                if ($total === 0) return '#e5e7eb'; // gray-200
                                if ($total <= 2) return '#86efac'; // green-300
                                if ($total <= 5) return '#fde047'; // yellow-300
                                if ($total <= 10) return '#fb923c'; // orange-400
                                return '#ef4444'; // red-500
                            }
                            
                            // Função para obter quantidade de equipamentos de uma cidade
                            function obterQuantidadeEquipamentos($nomeCidade, $cidadesEquipamentos) {
                                $nomeNormalizado = normalizarNomeCidade($nomeCidade);
                                foreach ($cidadesEquipamentos as $cidade => $dados) {
                                    if (normalizarNomeCidade($cidade) === $nomeNormalizado) {
                                        return $dados['total'];
                                    }
                                    // Tentar sem acentos
                                    $cidadeSemAcento = iconv('UTF-8', 'ASCII//TRANSLIT//IGNORE', normalizarNomeCidade($cidade));
                                    $nomeSemAcento = iconv('UTF-8', 'ASCII//TRANSLIT//IGNORE', $nomeNormalizado);
                                    if ($cidadeSemAcento === $nomeSemAcento) {
                                        return $dados['total'];
                                    }
                                }
                                return 0;
                            }
                        @endphp
                        
                        {{-- MAPA REAL DO TOCANTINS - Baseado em dados geográficos oficiais --}}
                        <svg viewBox="0 0 960 1747" 
                             class="w-full h-full mx-auto transition-transform duration-100" 
                             style="max-height: 680px;" 
                             preserveAspectRatio="xMidYMid meet"
                             :style="{ transform: `scale(${zoom}) translate(${panX}px, ${panY}px)` }">
                        
                        {{-- Estilos dinâmicos baseados em dados --}}
                        <style>
                            .municipio-path {
                                stroke: #1e3a5f;
                                stroke-width: 0.8;
                                transition: all 0.2s ease;
                                cursor: pointer;
                            }
                            .municipio-path:hover {
                                stroke: #f97316;
                                stroke-width: 2;
                                filter: brightness(1.1);
                            }
                        </style>
                        
                        <g>
                        {{-- Municípios do Tocantins com cores dinâmicas baseadas em equipamentos --}}
                        @php
                            $cidadesEquipamentos = [];
                            foreach($estabelecimentos as $est) {
                                // Pega o nome do município do campo 'cidade' e normaliza
                                $municipio = $est->cidade ?? 'Sem município';
                                // Remove sufixos como " - TO" ou "/TO"
                                $municipio = preg_replace('/\s*[-\/]\s*TO\s*$/i', '', $municipio);
                                $municipio = trim($municipio);
                                
                                if (empty($municipio)) {
                                    $municipio = 'Sem município';
                                }
                                
                                if (!isset($cidadesEquipamentos[$municipio])) {
                                    $cidadesEquipamentos[$municipio] = [
                                        'total' => 0,
                                        'estabelecimentos' => 0
                                    ];
                                }
                                $cidadesEquipamentos[$municipio]['total'] += $est->equipamentos_count;
                                $cidadesEquipamentos[$municipio]['estabelecimentos']++;
                            }
                            
                            // Coordenadas das cidades do Tocantins ajustadas para o novo formato do mapa
                            // ViewBox: 400x750 - Mapa mais centralizado
                            // Baseado na imagem real do Tocantins
                            $coordenadas = [
                                // ========== REGIÃO NORTE (Bico do Papagaio) ==========
                                'Buriti do Tocantins' => ['x' => 220, 'y' => 35],
                                'Esperantina' => ['x' => 185, 'y' => 28],
                                'Tocantinópolis' => ['x' => 265, 'y' => 85],
                                'São Miguel do Tocantins' => ['x' => 240, 'y' => 45],
                                'Sítio Novo do Tocantins' => ['x' => 258, 'y' => 55],
                                'Augustinópolis' => ['x' => 195, 'y' => 42],
                                'Araguatins' => ['x' => 170, 'y' => 55],
                                'Axixá do Tocantins' => ['x' => 210, 'y' => 58],
                                'Praia Norte' => ['x' => 158, 'y' => 45],
                                'Sampaio' => ['x' => 162, 'y' => 62],
                                'São Bento do Tocantins' => ['x' => 225, 'y' => 68],
                                'Carrasco Bonito' => ['x' => 175, 'y' => 50],
                                
                                // ========== REGIÃO XAMBIOÁ/ANANÁS ==========
                                'Xambioá' => ['x' => 135, 'y' => 115],
                                'Ananás' => ['x' => 215, 'y' => 105],
                                'Wanderlândia' => ['x' => 195, 'y' => 135],
                                'Darcinópolis' => ['x' => 235, 'y' => 95],
                                'Luzinópolis' => ['x' => 248, 'y' => 88],
                                'Palmeiras do Tocantins' => ['x' => 255, 'y' => 98],
                                'Nazaré' => ['x' => 228, 'y' => 110],
                                'Santa Terezinha do Tocantins' => ['x' => 242, 'y' => 105],
                                'Cachoeirinha' => ['x' => 235, 'y' => 118],
                                'Angico' => ['x' => 252, 'y' => 112],
                                'Riachinho' => ['x' => 222, 'y' => 125],
                                'Araguanã' => ['x' => 148, 'y' => 125],
                                'Piraquê' => ['x' => 158, 'y' => 135],
                                'São Sebastião do Tocantins' => ['x' => 205, 'y' => 115],
                                
                                // ========== REGIÃO ARAGUAÍNA ==========
                                'Araguaína' => ['x' => 175, 'y' => 175],
                                'Santa Fé do Araguaia' => ['x' => 115, 'y' => 185],
                                'Nova Olinda' => ['x' => 165, 'y' => 205],
                                'Babaçulândia' => ['x' => 230, 'y' => 185],
                                'Filadélfia' => ['x' => 255, 'y' => 198],
                                'Arapoema' => ['x' => 125, 'y' => 215],
                                'Palmeirante' => ['x' => 155, 'y' => 220],
                                'Muricilândia' => ['x' => 130, 'y' => 195],
                                'Pau D\'Arco' => ['x' => 105, 'y' => 205],
                                'Aragominas' => ['x' => 165, 'y' => 165],
                                'Carmolândia' => ['x' => 200, 'y' => 168],
                                'Bandeirantes do Tocantins' => ['x' => 145, 'y' => 235],
                                
                                // ========== REGIÃO CENTRO-NORTE ==========
                                'Colinas do Tocantins' => ['x' => 210, 'y' => 235],
                                'Goiatins' => ['x' => 295, 'y' => 225],
                                'Campos Lindos' => ['x' => 310, 'y' => 255],
                                'Guaraí' => ['x' => 180, 'y' => 285],
                                'Colméia' => ['x' => 165, 'y' => 270],
                                'Itacajá' => ['x' => 245, 'y' => 275],
                                'Pedro Afonso' => ['x' => 225, 'y' => 305],
                                'Itaporã do Tocantins' => ['x' => 195, 'y' => 295],
                                'Presidente Kennedy' => ['x' => 225, 'y' => 250],
                                'Goianorte' => ['x' => 155, 'y' => 255],
                                'Pequizeiro' => ['x' => 145, 'y' => 242],
                                'Couto Magalhães' => ['x' => 115, 'y' => 260],
                                'Juarina' => ['x' => 135, 'y' => 275],
                                'Itapiratins' => ['x' => 235, 'y' => 290],
                                'Centenário' => ['x' => 275, 'y' => 268],
                                'Recursolândia' => ['x' => 290, 'y' => 285],
                                'Rio Sono' => ['x' => 285, 'y' => 325],
                                'Lizarda' => ['x' => 310, 'y' => 295],
                                'Tupirama' => ['x' => 210, 'y' => 295],
                                'Tupiratins' => ['x' => 198, 'y' => 310],
                                'Bom Jesus do Tocantins' => ['x' => 245, 'y' => 318],
                                
                                // ========== REGIÃO CENTRAL (Palmas) ==========
                                'Araguacema' => ['x' => 85, 'y' => 320],
                                'Dois Irmãos do Tocantins' => ['x' => 130, 'y' => 300],
                                'Miracema do Tocantins' => ['x' => 160, 'y' => 365],
                                'Miranorte' => ['x' => 145, 'y' => 345],
                                'Barrolândia' => ['x' => 155, 'y' => 332],
                                'Rio dos Bois' => ['x' => 135, 'y' => 358],
                                'Lajeado' => ['x' => 195, 'y' => 378],
                                'Palmas' => ['x' => 205, 'y' => 410],
                                'Porto Nacional' => ['x' => 195, 'y' => 445],
                                'Paraíso do Tocantins' => ['x' => 130, 'y' => 398],
                                'Pium' => ['x' => 105, 'y' => 415],
                                'Tocantínia' => ['x' => 175, 'y' => 420],
                                'Aparecida do Rio Negro' => ['x' => 235, 'y' => 385],
                                'Novo Acordo' => ['x' => 265, 'y' => 365],
                                'Santa Tereza do Tocantins' => ['x' => 285, 'y' => 378],
                                'Lagoa do Tocantins' => ['x' => 295, 'y' => 362],
                                'Mateiros' => ['x' => 325, 'y' => 398],
                                'São Félix do Tocantins' => ['x' => 315, 'y' => 375],
                                'Ponte Alta do Tocantins' => ['x' => 280, 'y' => 425],
                                'Monte do Carmo' => ['x' => 240, 'y' => 455],
                                'Silvanópolis' => ['x' => 225, 'y' => 472],
                                'Santa Rosa do Tocantins' => ['x' => 260, 'y' => 485],
                                'Pugmil' => ['x' => 120, 'y' => 412],
                                'Crixás do Tocantins' => ['x' => 108, 'y' => 435],
                                'Cristalândia' => ['x' => 95, 'y' => 455],
                                'Lagoa da Confusão' => ['x' => 78, 'y' => 475],
                                'Fátima' => ['x' => 145, 'y' => 442],
                                'Oliveira de Fátima' => ['x' => 162, 'y' => 458],
                                'Brejinho de Nazaré' => ['x' => 180, 'y' => 475],
                                'Ipueiras' => ['x' => 165, 'y' => 495],
                                'Marianópolis do Tocantins' => ['x' => 115, 'y' => 462],
                                'Divinópolis do Tocantins' => ['x' => 130, 'y' => 478],
                                'Monte Santo do Tocantins' => ['x' => 98, 'y' => 482],
                                'Caseara' => ['x' => 75, 'y' => 358],
                                'Chapada de Areia' => ['x' => 115, 'y' => 375],
                                'Nova Rosalândia' => ['x' => 158, 'y' => 418],
                                
                                // ========== REGIÃO CENTRO-SUL ==========
                                'Natividade' => ['x' => 268, 'y' => 535],
                                'Almas' => ['x' => 285, 'y' => 515],
                                'Dianópolis' => ['x' => 310, 'y' => 545],
                                'Peixe' => ['x' => 195, 'y' => 535],
                                'São Valério' => ['x' => 215, 'y' => 510],
                                'Chapada da Natividade' => ['x' => 250, 'y' => 520],
                                'Paranã' => ['x' => 245, 'y' => 595],
                                'Pindorama do Tocantins' => ['x' => 265, 'y' => 555],
                                'Santa Maria do Tocantins' => ['x' => 248, 'y' => 365],
                                
                                // ========== REGIÃO SUL ==========
                                'Gurupi' => ['x' => 165, 'y' => 575],
                                'Formoso do Araguaia' => ['x' => 85, 'y' => 555],
                                'Dueré' => ['x' => 95, 'y' => 525],
                                'Alvorada' => ['x' => 145, 'y' => 595],
                                'Cariri do Tocantins' => ['x' => 155, 'y' => 608],
                                'Figueirópolis' => ['x' => 178, 'y' => 598],
                                'Aliança do Tocantins' => ['x' => 162, 'y' => 622],
                                'Araguaçu' => ['x' => 105, 'y' => 645],
                                'Sandolândia' => ['x' => 125, 'y' => 658],
                                'Sucupira' => ['x' => 172, 'y' => 638],
                                'Jaú do Tocantins' => ['x' => 208, 'y' => 625],
                                'Palmeirópolis' => ['x' => 195, 'y' => 658],
                                'São Salvador do Tocantins' => ['x' => 218, 'y' => 672],
                                'Talismã' => ['x' => 188, 'y' => 685],
                                
                                // ========== REGIÃO SUDESTE ==========
                                'Taguatinga' => ['x' => 308, 'y' => 605],
                                'Arraias' => ['x' => 268, 'y' => 655],
                                'Conceição do Tocantins' => ['x' => 255, 'y' => 635],
                                'Aurora do Tocantins' => ['x' => 245, 'y' => 668],
                                'Combinado' => ['x' => 235, 'y' => 695],
                                'Lavandeira' => ['x' => 258, 'y' => 688],
                                'Novo Alegre' => ['x' => 272, 'y' => 710],
                                'Novo Jardim' => ['x' => 318, 'y' => 575],
                                'Taipas do Tocantins' => ['x' => 295, 'y' => 658],
                                'Ponte Alta do Bom Jesus' => ['x' => 278, 'y' => 575],
                                'Porto Alegre do Tocantins' => ['x' => 315, 'y' => 625],
                                'Rio da Conceição' => ['x' => 328, 'y' => 528],
                            ];
                        @endphp
                        
                        {{-- Primeiro, desenhar TODAS as cidades principais como pontos pequenos cinzas --}}
                        @foreach($coordenadas as $nomeCidade => $coords)
                            @php
                                $temDados = isset($cidadesEquipamentos[$nomeCidade]);
                            @endphp
                            @if(!$temDados)
                                <circle cx="{{ $coords['x'] }}" cy="{{ $coords['y'] }}" r="3" 
                                        fill="#d1d5db" stroke="#9ca3af" stroke-width="0.5" opacity="0.6"/>
                                <text x="{{ $coords['x'] }}" y="{{ $coords['y'] + 8 }}" 
                                      text-anchor="middle" fill="#9ca3af" font-size="5">
                                    {{ Str::limit($nomeCidade, 10) }}
                                </text>
                            @endif
                        @endforeach

                        {{-- Depois, desenhar as cidades com equipamentos em destaque --}}
                        @foreach($cidadesEquipamentos as $cidade => $dados)
                            @php
                                // Tentar encontrar a cidade nas coordenadas
                                $coordEncontrada = null;
                                foreach ($coordenadas as $nomeCidade => $coords) {
                                    // Comparação case-insensitive e com normalização
                                    $cidadeNormalizada = mb_strtolower(trim($cidade));
                                    $nomeCidadeNormalizado = mb_strtolower(trim($nomeCidade));
                                    
                                    if ($cidadeNormalizada === $nomeCidadeNormalizado) {
                                        $coordEncontrada = $coords;
                                        break;
                                    }
                                    // Tentar sem acentos
                                    $cidadeSemAcento = iconv('UTF-8', 'ASCII//TRANSLIT//IGNORE', $cidadeNormalizada);
                                    $nomeSemAcento = iconv('UTF-8', 'ASCII//TRANSLIT//IGNORE', $nomeCidadeNormalizado);
                                    if ($cidadeSemAcento === $nomeSemAcento) {
                                        $coordEncontrada = $coords;
                                        break;
                                    }
                                }
                                
                                if (!$coordEncontrada) {
                                    // Se não encontrou, colocar no centro do mapa
                                    $coordEncontrada = ['x' => 175, 'y' => 350];
                                }
                                
                                $x = $coordEncontrada['x'];
                                $y = $coordEncontrada['y'];
                                $total = $dados['total'];
                                $radius = min(25, max(12, 10 + $total * 2));
                                $color = $total > 10 ? '#dc2626' : ($total > 5 ? '#ea580c' : ($total > 0 ? '#f59e0b' : '#94a3b8'));
                            @endphp
                            
                            <g class="cidade-marker cursor-pointer hover:scale-110 transition-transform"
                               style="transform-origin: {{ $x }}px {{ $y }}px;"
                               @mouseenter="cidadeSelecionada = '{{ addslashes($cidade) }}'"
                               @mouseleave="cidadeSelecionada = null"
                               @click.stop="abrirModalCidade('{{ addslashes($cidade) }}')">
                                {{-- Círculo pulsante para destaque --}}
                                <circle cx="{{ $x }}" cy="{{ $y }}" r="{{ $radius + 5 }}" 
                                        fill="{{ $color }}" opacity="0.2">
                                    <animate attributeName="r" 
                                             values="{{ $radius }};{{ $radius + 10 }};{{ $radius }}" 
                                             dur="2s" repeatCount="indefinite"/>
                                    <animate attributeName="opacity" 
                                             values="0.3;0.1;0.3" 
                                             dur="2s" repeatCount="indefinite"/>
                                </circle>
                                
                                {{-- Círculo principal --}}
                                <circle cx="{{ $x }}" cy="{{ $y }}" r="{{ $radius }}" 
                                        fill="{{ $color }}" stroke="white" stroke-width="2"
                                        class="drop-shadow-lg hover:stroke-orange-400 hover:stroke-[3px] transition-all"/>
                                
                                {{-- Número de equipamentos --}}
                                <text x="{{ $x }}" y="{{ $y + 1 }}" 
                                      text-anchor="middle" dominant-baseline="middle"
                                      fill="white" font-size="{{ $total > 99 ? '9' : '11' }}" font-weight="bold"
                                      class="pointer-events-none">
                                    {{ $total }}
                                </text>
                                
                                {{-- Nome da cidade --}}
                                <text x="{{ $x }}" y="{{ $y + $radius + 12 }}" 
                                      text-anchor="middle" 
                                      fill="#1f2937" font-size="8" font-weight="bold"
                                      class="pointer-events-none">
                                    {{ Str::limit($cidade, 15) }}
                                </text>
                            </g>
                        @endforeach
                    </svg>
                    </div>
                    
                    {{-- Legenda --}}
                    <div class="absolute bottom-4 left-4 bg-white rounded-lg shadow-lg p-4 border border-gray-200 z-10">
                        <h4 class="font-semibold text-gray-900 text-sm mb-3">Legenda</h4>
                        <div class="space-y-2 text-xs">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-gray-400"></div>
                                <span class="text-gray-600">Sem equipamentos</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-yellow-500"></div>
                                <span class="text-gray-600">1-5 equipamentos</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-orange-600"></div>
                                <span class="text-gray-600">6-10 equipamentos</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded-full bg-red-600"></div>
                                <span class="text-gray-600">Mais de 10</span>
                            </div>
                        </div>
                    </div>
                    
                    {{-- Tooltip da cidade --}}
                    <div x-show="cidadeSelecionada" 
                         x-transition
                         class="absolute top-4 right-4 bg-white rounded-lg shadow-xl p-4 border border-gray-200 min-w-[200px]">
                        <template x-if="cidadeSelecionada">
                            <div>
                                <h4 class="font-bold text-gray-900 mb-2" x-text="cidadeSelecionada"></h4>
                                @foreach($cidadesEquipamentos as $cidade => $dados)
                                    <div x-show="cidadeSelecionada === '{{ $cidade }}'">
                                        <div class="space-y-1 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Estabelecimentos:</span>
                                                <span class="font-semibold text-gray-900">{{ $dados['estabelecimentos'] }}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Equipamentos:</span>
                                                <span class="font-semibold text-orange-600">{{ $dados['total'] }}</span>
                                            </div>
                                        </div>
                                    </div>
                                @endforeach
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            {{-- Lista de cidades --}}
            <div class="lg:col-span-1">
                <div class="bg-gray-50 rounded-xl p-4 h-full overflow-y-auto" style="max-height: 700px;">
                    <h3 class="font-bold text-gray-900 mb-4 sticky top-0 bg-gray-50 pb-2">
                        Cidades com Equipamentos
                        <span class="text-sm font-normal text-gray-500">(clique para ver detalhes)</span>
                    </h3>
                    <div class="space-y-2">
                        @foreach($cidadesEquipamentos as $cidade => $dados)
                            <div class="bg-white rounded-lg p-3 border border-gray-200 hover:border-orange-300 hover:shadow-md transition-all cursor-pointer"
                                 @mouseenter="cidadeSelecionada = '{{ addslashes($cidade) }}'"
                                 @mouseleave="cidadeSelecionada = null"
                                 @click="abrirModalCidade('{{ addslashes($cidade) }}')">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-900 text-sm">{{ $cidade }}</h4>
                                        <div class="text-xs text-gray-500 mt-1">
                                            {{ $dados['estabelecimentos'] }} estabelecimento{{ $dados['estabelecimentos'] > 1 ? 's' : '' }}
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end">
                                        <span class="inline-flex items-center justify-center w-10 h-10 rounded-full text-sm font-bold text-white
                                            {{ $dados['total'] > 10 ? 'bg-red-600' : ($dados['total'] > 5 ? 'bg-orange-600' : ($dados['total'] > 0 ? 'bg-yellow-500' : 'bg-gray-400')) }}">
                                            {{ $dados['total'] }}
                                        </span>
                                        <span class="text-xs text-gray-500 mt-1">equip.</span>
                                    </div>
                                </div>
                            </div>
                        @endforeach
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {{-- Modal de Estabelecimentos da Cidade --}}
    <div x-show="modalCidade" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto" 
         style="display: none;">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
            {{-- Overlay --}}
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="fecharModalCidade()"></div>
            
            {{-- Modal Content --}}
            <div class="relative bg-white rounded-2xl shadow-xl transform transition-all sm:max-w-3xl sm:w-full mx-4"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
                
                {{-- Header --}}
                <div class="bg-gradient-to-r from-orange-500 to-amber-500 px-6 py-4 rounded-t-2xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-white/20 rounded-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white" x-text="cidadeModal"></h3>
                                <p class="text-orange-100 text-sm">Estabelecimentos com equipamentos de radiação</p>
                            </div>
                        </div>
                        <button @click="fecharModalCidade()" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                {{-- Body --}}
                <div class="px-6 py-4 max-h-[60vh] overflow-y-auto">
                    <template x-if="estabelecimentosCidade.length > 0">
                        <div class="space-y-3">
                            <template x-for="est in estabelecimentosCidade" :key="est.id">
                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200 hover:border-orange-300 transition-colors">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-900" x-text="est.nome"></h4>
                                            <p class="text-sm text-gray-500 mt-1" x-text="est.cnpj"></p>
                                            <div class="flex flex-wrap gap-2 mt-2">
                                                <template x-for="ativ in est.atividades" :key="ativ">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800" x-text="ativ"></span>
                                                </template>
                                            </div>
                                        </div>
                                        <div class="flex flex-col items-end ml-4">
                                            <span class="inline-flex items-center justify-center w-12 h-12 rounded-full text-lg font-bold text-white"
                                                  :class="est.equipamentos > 10 ? 'bg-red-600' : (est.equipamentos > 5 ? 'bg-orange-600' : (est.equipamentos > 0 ? 'bg-yellow-500' : 'bg-gray-400'))"
                                                  x-text="est.equipamentos">
                                            </span>
                                            <span class="text-xs text-gray-500 mt-1">equipamentos</span>
                                        </div>
                                    </div>
                                    <div class="mt-3 pt-3 border-t border-gray-200 flex items-center justify-between">
                                        <span class="text-xs text-gray-400" x-text="'ID: ' + est.id"></span>
                                        <a :href="'/admin/estabelecimentos/' + est.id + '/equipamentos-radiacao'" 
                                           class="inline-flex items-center gap-1 text-sm text-orange-600 hover:text-orange-700 font-medium">
                                            Ver equipamentos
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                            </svg>
                                        </a>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                    <template x-if="estabelecimentosCidade.length === 0">
                        <div class="text-center py-8">
                            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-gray-500">Nenhum estabelecimento encontrado nesta cidade.</p>
                        </div>
                    </template>
                </div>
                
                {{-- Footer --}}
                <div class="bg-gray-50 px-6 py-4 rounded-b-2xl flex justify-end">
                    <button @click="fecharModalCidade()" 
                            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    {{-- Tabela --}}
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden" x-show="visualizacao === 'tabela'" x-collapse>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Estabelecimento
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            CNPJ
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Atividade(s) com Radiação
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Equipamentos
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Ações
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    @forelse($estabelecimentos as $estabelecimento)
                        <tr class="hover:bg-gray-50 transition-colors"
                            x-show="filtrarLinha({{ json_encode([
                                'id' => $estabelecimento->id,
                                'nome' => $estabelecimento->nome_fantasia ?? $estabelecimento->razao_social,
                                'cnpj' => $estabelecimento->cnpj,
                                'tem_equipamentos' => $estabelecimento->equipamentos_count > 0,
                                'atividades_codigos' => $estabelecimento->atividades_radiacao->pluck('codigo_atividade')->map(fn($c) => preg_replace('/[^0-9]/', '', $c))->toArray()
                            ]) }})">
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900">
                                    {{ $estabelecimento->nome_fantasia ?? $estabelecimento->razao_social }}
                                </div>
                                @if($estabelecimento->nome_fantasia && $estabelecimento->razao_social)
                                    <div class="text-xs text-gray-500">
                                        {{ $estabelecimento->razao_social }}
                                    </div>
                                @endif
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-600">
                                {{ $estabelecimento->cnpj ? preg_replace('/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/', '$1.$2.$3/$4-$5', $estabelecimento->cnpj) : '-' }}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-wrap gap-1">
                                    @foreach($estabelecimento->atividades_radiacao as $atividade)
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800">
                                            {{ Str::limit($atividade->descricao_atividade, 30) }}
                                        </span>
                                    @endforeach
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="text-lg font-semibold {{ $estabelecimento->equipamentos_count > 0 ? 'text-green-600' : 'text-gray-400' }}">
                                    {{ $estabelecimento->equipamentos_count }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                @if($estabelecimento->equipamentos_count > 0)
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                        </svg>
                                        Cadastrado
                                    </span>
                                @else
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                        </svg>
                                        Pendente
                                    </span>
                                @endif
                            </td>
                            <td class="px-6 py-4 text-center">
                                <a href="{{ route('admin.estabelecimentos.equipamentos-radiacao.index', $estabelecimento) }}" 
                                   class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-orange-600 hover:text-orange-800 hover:bg-orange-50 rounded-lg transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                    Ver equipamentos
                                </a>
                            </td>
                        </tr>
                    @empty
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                <svg class="w-12 h-12 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                <p class="text-lg font-medium">Nenhum estabelecimento encontrado</p>
                                <p class="text-sm">Não há estabelecimentos com atividades que exijam equipamentos de radiação.</p>
                            </td>
                        </tr>
                    @endforelse
                </tbody>
            </table>
        </div>
    </div>

    {{-- Contador de resultados filtrados --}}
    <div class="text-sm text-gray-500 text-center" x-show="visualizacao === 'tabela' && resultadosFiltrados !== null">
        Mostrando <span class="font-medium" x-text="resultadosFiltrados"></span> de {{ count($estabelecimentos) }} estabelecimentos
    </div>
</div>

<script>
function relatorioEquipamentosRadiacao() {
    return {
        visualizacao: 'tabela', // 'tabela' ou 'mapa'
        cidadeSelecionada: null,
        filtros: {
            busca: '',
            status: '',
            atividade: ''
        },
        resultadosFiltrados: null,
        
        // Zoom e Pan
        zoom: 1,
        panX: 0,
        panY: 0,
        isPanning: false,
        startX: 0,
        startY: 0,
        
        // Modal
        modalCidade: false,
        cidadeModal: '',
        estabelecimentosCidade: [],
        
        // Dados dos estabelecimentos por cidade
        dadosEstabelecimentos: {!! json_encode($estabelecimentos->map(function($est) {
            $cidade = $est->cidade ?? 'Sem município';
            $cidade = preg_replace('/\s*[-\/]\s*TO\s*$/i', '', $cidade);
            $cidade = trim($cidade) ?: 'Sem município';
            
            return [
                'id' => $est->id,
                'nome' => $est->nome_fantasia ?: $est->razao_social,
                'cnpj' => $est->cnpj ? preg_replace('/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/', '$1.$2.$3/$4-$5', $est->cnpj) : 'N/A',
                'cidade' => $cidade,
                'equipamentos' => $est->equipamentos_count,
                'atividades' => $est->atividades_radiacao->pluck('descricao')->toArray()
            ];
        })) !!},
        
        // Mapeamento de ID da atividade para código normalizado
        atividadesMap: {!! json_encode($atividades->mapWithKeys(fn($a) => [$a->id => preg_replace('/[^0-9]/', '', $a->codigo_atividade)])) !!},

        // Funções de Zoom
        zoomIn() {
            this.zoom = Math.min(this.zoom + 0.25, 4);
        },
        
        zoomOut() {
            this.zoom = Math.max(this.zoom - 0.25, 0.5);
            if (this.zoom <= 1) {
                this.panX = 0;
                this.panY = 0;
            }
        },
        
        resetZoom() {
            this.zoom = 1;
            this.panX = 0;
            this.panY = 0;
        },
        
        handleWheel(event) {
            if (event.deltaY < 0) {
                this.zoomIn();
            } else {
                this.zoomOut();
            }
        },
        
        // Funções de Pan
        startPan(event) {
            if (this.zoom > 1) {
                this.isPanning = true;
                this.startX = event.clientX - this.panX;
                this.startY = event.clientY - this.panY;
            }
        },
        
        doPan(event) {
            if (this.isPanning && this.zoom > 1) {
                this.panX = event.clientX - this.startX;
                this.panY = event.clientY - this.startY;
                
                // Limitar o pan para não sair muito da área
                const maxPan = (this.zoom - 1) * 200;
                this.panX = Math.max(-maxPan, Math.min(maxPan, this.panX));
                this.panY = Math.max(-maxPan, Math.min(maxPan, this.panY));
            }
        },
        
        endPan() {
            this.isPanning = false;
        },
        
        // Modal de Cidade
        abrirModalCidade(cidade) {
            this.cidadeModal = cidade;
            this.estabelecimentosCidade = this.dadosEstabelecimentos.filter(est => est.cidade === cidade);
            this.modalCidade = true;
            document.body.style.overflow = 'hidden';
        },
        
        fecharModalCidade() {
            this.modalCidade = false;
            this.cidadeModal = '';
            this.estabelecimentosCidade = [];
            document.body.style.overflow = '';
        },

        filtrarLinha(item) {
            // Filtro de busca
            if (this.filtros.busca) {
                const busca = this.filtros.busca.toLowerCase();
                const nome = item.nome.toLowerCase();
                const cnpj = (item.cnpj || '').replace(/\D/g, '');
                const buscaLimpa = busca.replace(/\D/g, '');
                
                if (!nome.includes(busca) && !cnpj.includes(buscaLimpa)) {
                    return false;
                }
            }

            // Filtro de status
            if (this.filtros.status === 'com' && !item.tem_equipamentos) {
                return false;
            }
            if (this.filtros.status === 'sem' && item.tem_equipamentos) {
                return false;
            }

            // Filtro de atividade (compara código normalizado)
            if (this.filtros.atividade) {
                const codigoFiltro = this.atividadesMap[this.filtros.atividade];
                if (codigoFiltro && !item.atividades_codigos.includes(codigoFiltro)) {
                    return false;
                }
            }

            return true;
        },

        filtrar() {
            this.$nextTick(() => {
                const visibleRows = document.querySelectorAll('tbody tr[x-show]:not([style*="display: none"])');
                this.resultadosFiltrados = visibleRows.length;
            });
        },

        limparFiltros() {
            this.filtros.busca = '';
            this.filtros.status = '';
            this.filtros.atividade = '';
            this.resultadosFiltrados = null;
        },

        exportarExcel() {
            const params = new URLSearchParams(this.filtros);
            window.location.href = `{{ route('admin.relatorios.equipamentos-radiacao.export') }}?${params.toString()}`;
        }
    }
}
</script>
@endsection
